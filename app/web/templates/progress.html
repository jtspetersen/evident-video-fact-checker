{% extends "base.html" %}

{% block title %}Evident â€” {{ runner.video_title or run_id }}{% endblock %}

{% block head %}
<style>
    .stage-detail {
        display: none;
        margin: 0.75rem 0;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        background: var(--pico-card-background-color);
        border: 1px solid var(--pico-muted-border-color);
    }
    .stage-detail.visible { display: block; }
    .stage-detail h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.95em;
    }
    .stage-detail .detail-message {
        font-size: 0.85em;
        color: var(--pico-muted-color);
        margin-bottom: 0.4rem;
    }
    .stage-detail progress {
        width: 100%;
        height: 1.2rem;
    }
    .stage-detail .detail-stats {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.4rem;
        font-size: 0.85em;
    }
    .stage-detail .detail-stats strong {
        font-size: 1.1em;
    }
</style>
{% endblock %}

{% block content %}
<hgroup>
    <h1 id="run-title">Fact-Checking Video: {{ runner.video_title or 'Loading...' }}</h1>
    <p>
        Channel: <strong id="run-channel">{{ runner.channel }}</strong>
        &mdash;
        Status: <span id="status-badge" class="badge badge-{{ runner.status }}">{{ runner.status }}</span>
    </p>
</hgroup>

<!-- Stage timeline -->
{% set stage_labels = {
    "prepare_transcript": "Prepare Transcript",
    "extract_claims": "Extract Claims",
    "review_claims": "Review Claims",
    "gather_evidence": "Gather Evidence",
    "check_claims": "Check Claims",
    "fact_check_summary": "Fact-Check Summary",
} %}
{% set timings = runner.manifest.get('timings', {}) %}
<h3>Pipeline Stages</h3>
<div class="stage-timeline" id="stage-timeline">
    {% for stage in runner.STAGE_ORDER %}
    {% set t = timings.get(stage, {}) %}
    <div class="stage-box{% if t.get('finished_utc') %} completed{% elif runner.current_stage == stage %} active{% elif t.get('skipped') %} skipped{% endif %}"
         id="stage-{{ stage }}" data-stage="{{ stage }}">
        {{ stage_labels.get(stage, stage.replace('_', ' ').title()) }}
    </div>
    {% endfor %}
</div>

<!-- Prepare transcript detail panel (YouTube fetch + normalize) -->
<div class="stage-detail" id="prepare-detail">
    <h4>Preparing Transcript</h4>
    <div class="detail-message" id="prepare-message">Preparing...</div>
    <div class="detail-stats">
        <div>Source: <strong id="prepare-source">pending</strong></div>
    </div>
</div>

<!-- Extract claims detail panel (extraction + consolidation) -->
<div class="stage-detail" id="extract-detail">
    <h4>Extracting Claims</h4>
    <div class="detail-message" id="extract-message">Preparing...</div>
    <progress id="extract-bar" value="0" max="1"></progress>
    <div class="detail-stats">
        <div>Chunk <strong id="extract-chunk">0</strong> / <span id="extract-total">1</span></div>
        <div>Claims found: <strong id="extract-claims">0</strong></div>
    </div>
    <!-- Consolidation sub-stats (shown when consolidation runs) -->
    <div id="consolidate-stats" style="display:none; margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid var(--pico-muted-border-color);">
        <div class="detail-message" id="consolidate-message">Analyzing claims for duplicates and narrative groups...</div>
        <div class="detail-stats">
            <div>Duplicates removed: <strong id="consolidate-dupes">0</strong></div>
            <div>Narrative groups: <strong id="consolidate-groups">0</strong></div>
        </div>
    </div>
</div>

<!-- Gather evidence detail panel -->
<div class="stage-detail" id="retrieve-detail">
    <h4>Gathering Evidence</h4>
    <div class="detail-message" id="retrieve-message">Preparing...</div>
    <progress id="retrieve-bar" value="0" max="1"></progress>
    <div class="detail-stats">
        <div>Claim <strong id="retrieve-claim-idx">0</strong> / <span id="retrieve-total">0</span></div>
        <div>Sources: <strong id="retrieve-sources">0</strong></div>
        <div>Snippets: <strong id="retrieve-snippets">0</strong></div>
        <div>Failures: <strong id="retrieve-failures">0</strong></div>
    </div>
</div>

<!-- Check claims detail panel -->
<div class="stage-detail" id="verify-detail">
    <h4>Checking Claims</h4>
    <div class="detail-message" id="verify-message">Preparing...</div>
    <progress id="verify-bar" value="0" max="1"></progress>
    <div class="detail-stats">
        <div>Checked <strong id="verify-current">0</strong> / <span id="verify-total">0</span></div>
    </div>
</div>

<!-- Counters (seeded from manifest so they survive page reloads) -->
{% set cnts = runner.manifest.get('counts', {}) %}
<div class="grid" id="counters" style="margin:1rem 0;">
    <div>
        <strong id="cnt-claims">{{ cnts.get('claims_kept', 0) }}</strong>
        <small>Claims</small>
    </div>
    <div>
        <strong id="cnt-sources">{{ cnts.get('sources', 0) }}</strong>
        <small>Sources</small>
    </div>
    <div>
        <strong id="cnt-snippets">{{ cnts.get('snippets', 0) }}</strong>
        <small>Snippets</small>
    </div>
    <div>
        <strong id="cnt-verdicts">{{ cnts.get('verdicts', 0) }}</strong>
        <small>Verdicts</small>
    </div>
    <div>
        <strong id="cnt-failures">{{ cnts.get('fetch_failures', 0) }}</strong>
        <small>Failures</small>
    </div>
    <div>
        <strong id="cnt-groups">{{ cnts.get('narrative_groups', 0) }}</strong>
        <small>Groups</small>
    </div>
</div>

<!-- Stop button -->
<div style="margin: 1rem 0;" id="stop-container">
    <form method="POST" action="/run/{{ run_id }}/stop"
          onsubmit="return confirm('Stop this run?');">
        <button type="submit" class="outline secondary" id="stop-btn">
            Stop Run
        </button>
    </form>
</div>

<!-- Log stream -->
<h3>Log</h3>
<div class="log-stream" id="log-stream">
    <div class="log-line">Waiting for events...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const runId = '{{ run_id }}';
    const logStream = document.getElementById('log-stream');
    const statusBadge = document.getElementById('status-badge');
    let logStarted = false;
    let sseConnected = false;

    // Initialize completed stages from server-rendered classes (survives page reloads)
    let completedStages = new Set();
    let activeStage = null;
    document.querySelectorAll('.stage-box.completed').forEach(function(el) {
        completedStages.add(el.dataset.stage);
    });
    document.querySelectorAll('.stage-box.active').forEach(function(el) {
        activeStage = el.dataset.stage;
    });

    // Detail panel elements
    const prepareDetail = document.getElementById('prepare-detail');
    const extractDetail = document.getElementById('extract-detail');
    const retrieveDetail = document.getElementById('retrieve-detail');
    const verifyDetail = document.getElementById('verify-detail');
    const allPanels = [prepareDetail, extractDetail, retrieveDetail, verifyDetail];

    function showPanel(panel) { panel.classList.add('visible'); }
    function hidePanel(panel) { panel.classList.remove('visible'); }
    function hideAllPanels() { allPanels.forEach(function(p) { hidePanel(p); }); }

    function addLog(text) {
        if (!logStarted) {
            logStream.innerHTML = '';
            logStarted = true;
        }
        const div = document.createElement('div');
        div.className = 'log-line';
        div.textContent = text;
        logStream.appendChild(div);
        while (logStream.children.length > 50) {
            logStream.removeChild(logStream.firstChild);
        }
        logStream.scrollTop = logStream.scrollHeight;
    }

    const source = new EventSource('/run/' + runId + '/events');

    source.onopen = function() {
        sseConnected = true;
        console.log('SSE connected');
    };

    // Stage -> detail panel mapping
    var stagePanels = {
        'prepare_transcript': prepareDetail,
        'extract_claims': extractDetail,
        'gather_evidence': retrieveDetail,
        'check_claims': verifyDetail,
    };

    // -- Stage transitions --
    source.addEventListener('stage', function(e) {
        const data = JSON.parse(e.data);
        const el = document.getElementById('stage-' + data.name);
        if (!el) return;

        if (data.status === 'started') {
            if (activeStage && activeStage !== data.name) {
                const prev = document.getElementById('stage-' + activeStage);
                if (prev) {
                    prev.classList.remove('active');
                    prev.classList.add('completed');
                }
                completedStages.add(activeStage);
            }
            el.classList.add('active');
            el.classList.remove('completed');
            activeStage = data.name;

            // Show/hide detail panels based on which stage is active
            hideAllPanels();
            var panel = stagePanels[data.name];
            if (panel) showPanel(panel);

        } else if (data.status === 'completed') {
            el.classList.remove('active');
            el.classList.add('completed');
            completedStages.add(data.name);
            if (activeStage === data.name) activeStage = null;

            // Hide the detail panel for this stage
            var panel = stagePanels[data.name];
            if (panel) hidePanel(panel);
        }
    });

    // -- YouTube transcript fetch progress --
    source.addEventListener('youtube_progress', function(e) {
        const d = JSON.parse(e.data);
        showPanel(prepareDetail);

        const msg = document.getElementById('prepare-message');
        const srcEl = document.getElementById('prepare-source');

        if (d.status === 'extracting_id') {
            msg.textContent = 'Parsing YouTube URL...';
        } else if (d.status === 'fetching_metadata') {
            msg.textContent = 'Fetching video metadata...';
        } else if (d.status === 'trying_captions') {
            msg.textContent = 'Looking for existing YouTube captions...';
        } else if (d.status === 'captions_found') {
            msg.textContent = 'Captions found! Downloading transcript...';
            srcEl.textContent = 'captions';
        } else if (d.status === 'no_captions') {
            msg.textContent = 'No captions available. Falling back to Whisper transcription...';
        } else if (d.status === 'downloading_audio') {
            msg.textContent = 'Downloading audio from YouTube...';
            srcEl.textContent = 'whisper';
        } else if (d.status === 'transcribing') {
            msg.textContent = 'Transcribing audio with Whisper (this may take a few minutes)...';
            srcEl.textContent = 'whisper';
        } else if (d.status === 'done') {
            msg.textContent = 'Transcript ready (' + (d.source || 'unknown') + ')';
            srcEl.textContent = d.source || 'done';
        }
    });

    // -- Run info update (video title / channel from YouTube metadata) --
    source.addEventListener('run_info', function(e) {
        const d = JSON.parse(e.data);
        if (d.video_title) {
            document.getElementById('run-title').textContent = 'Fact-Checking Video: ' + d.video_title;
        }
        if (d.channel) {
            document.getElementById('run-channel').textContent = d.channel;
        }
    });

    // -- Extract claims progress --
    source.addEventListener('extract_progress', function(e) {
        const d = JSON.parse(e.data);
        showPanel(extractDetail);

        const bar = document.getElementById('extract-bar');
        const msg = document.getElementById('extract-message');
        const chunkEl = document.getElementById('extract-chunk');
        const totalEl = document.getElementById('extract-total');
        const claimsEl = document.getElementById('extract-claims');

        bar.max = d.total_chunks || 1;
        totalEl.textContent = d.total_chunks || 1;

        if (d.claims_so_far !== undefined) {
            claimsEl.textContent = d.claims_so_far;
            document.getElementById('cnt-claims').textContent = d.claims_so_far;
        }

        if (d.status === 'starting') {
            chunkEl.textContent = '0';
            bar.value = 0;
            msg.textContent = 'Preparing to extract claims from ' + d.total_chunks + ' chunks...';
        } else if (d.status === 'extracting') {
            bar.value = Math.max(0, (d.chunk || 1) - 1);
            chunkEl.textContent = d.chunk || 1;
            msg.textContent = 'Analyzing chunk ' + d.chunk + ' of ' + d.total_chunks + '...';
        } else if (d.status === 'chunk_done') {
            bar.value = d.chunk;
            chunkEl.textContent = d.chunk;
            msg.textContent = 'Chunk ' + d.chunk + ' complete \u2014 ' + (d.chunk_claims || 0) + ' claims found (' + (d.claims_so_far || 0) + ' total)';
        } else if (d.status === 'done') {
            bar.value = bar.max;
            msg.textContent = 'Extraction complete';
        }
    });

    // -- Consolidate claims progress (shown inline in extract panel) --
    source.addEventListener('consolidate_progress', function(e) {
        const d = JSON.parse(e.data);
        showPanel(extractDetail);

        const statsDiv = document.getElementById('consolidate-stats');
        const msg = document.getElementById('consolidate-message');
        const dupesEl = document.getElementById('consolidate-dupes');
        const groupsEl = document.getElementById('consolidate-groups');

        statsDiv.style.display = 'block';

        if (d.status === 'analyzing') {
            msg.textContent = 'Analyzing ' + d.total_claims + ' claims for duplicates and narrative groups...';
        } else if (d.status === 'done') {
            dupesEl.textContent = d.duplicates_removed || 0;
            groupsEl.textContent = d.groups || 0;
            document.getElementById('cnt-groups').textContent = d.groups || 0;
            document.getElementById('cnt-claims').textContent = d.total_claims || 0;
            msg.textContent = 'Consolidation complete \u2014 ' + (d.duplicates_removed || 0) + ' duplicates removed, ' + (d.groups || 0) + ' narrative groups';
        } else if (d.status === 'skipped') {
            msg.textContent = 'Skipped: ' + (d.reason || 'N/A');
        } else if (d.status === 'error') {
            msg.textContent = 'Consolidation failed, continuing with original claims';
        }
    });

    // -- Retrieve evidence progress --
    source.addEventListener('retrieve_progress', function(e) {
        const d = JSON.parse(e.data);
        showPanel(retrieveDetail);

        const bar = document.getElementById('retrieve-bar');
        const msg = document.getElementById('retrieve-message');
        const idxEl = document.getElementById('retrieve-claim-idx');
        const totalEl = document.getElementById('retrieve-total');
        const srcEl = document.getElementById('retrieve-sources');
        const snipEl = document.getElementById('retrieve-snippets');
        const failEl = document.getElementById('retrieve-failures');

        bar.max = d.total_claims || 1;
        totalEl.textContent = d.total_claims || 0;
        srcEl.textContent = d.sources || 0;
        snipEl.textContent = d.snippets || 0;
        failEl.textContent = d.failures || 0;

        // Update main counters
        document.getElementById('cnt-sources').textContent = d.sources || 0;
        document.getElementById('cnt-snippets').textContent = d.snippets || 0;
        document.getElementById('cnt-failures').textContent = d.failures || 0;

        if (d.status === 'searching') {
            bar.value = Math.max(0, (d.claim_idx || 1) - 1);
            idxEl.textContent = d.claim_idx || 1;
            msg.textContent = 'Searching for evidence \u2014 claim ' + d.claim_idx + '/' + d.total_claims + ' (' + d.claim_id + ')...';
        } else if (d.status === 'done') {
            bar.value = d.claim_idx;
            idxEl.textContent = d.claim_idx;
            msg.textContent = 'Claim ' + d.claim_idx + '/' + d.total_claims + ' done \u2014 ' + (d.claim_sources || 0) + ' snippets matched';
        }
    });

    // -- Generic progress events (stage-end summaries) --
    source.addEventListener('progress', function(e) {
        const data = JSON.parse(e.data);
        if (data.claims_extracted !== undefined) {
            document.getElementById('cnt-claims').textContent = data.claims_extracted;
        }
        if (data.sources !== undefined) {
            document.getElementById('cnt-sources').textContent = data.sources;
        }
        if (data.snippets !== undefined) {
            document.getElementById('cnt-snippets').textContent = data.snippets;
        }
        if (data.fetch_failures !== undefined) {
            document.getElementById('cnt-failures').textContent = data.fetch_failures;
        }
    });

    // -- Verify claims progress --
    source.addEventListener('verify_progress', function(e) {
        const d = JSON.parse(e.data);
        const cur = d.current;
        const tot = d.total;

        // Update global counter
        document.getElementById('cnt-verdicts').textContent = cur + '/' + tot;

        // Update verify detail panel
        showPanel(verifyDetail);
        document.getElementById('verify-bar').max = tot;
        document.getElementById('verify-bar').value = cur;
        document.getElementById('verify-current').textContent = cur;
        document.getElementById('verify-total').textContent = tot;
        document.getElementById('verify-message').textContent = 'Checked ' + cur + ' of ' + tot + ' claims...';
    });

    // -- Log messages --
    source.addEventListener('log', function(e) {
        const data = JSON.parse(e.data);
        addLog(data.message);
    });

    // -- Status changes --
    source.addEventListener('status', function(e) {
        const data = JSON.parse(e.data);
        statusBadge.textContent = data.status;
        statusBadge.className = 'badge badge-' + data.status;
    });

    // -- Review pause --
    source.addEventListener('review_ready', function(e) {
        window.location.href = '/run/' + runId + '/review';
    });

    // -- Pipeline complete --
    source.addEventListener('done', function(e) {
        const data = JSON.parse(e.data);
        source.close();

        var doneStatus = data.status === 'cancelled' ? 'cancelled' : 'done';
        statusBadge.textContent = doneStatus;
        statusBadge.className = 'badge badge-' + doneStatus;

        hideAllPanels();
        document.getElementById('stop-container').style.display = 'none';

        document.querySelectorAll('.stage-box.active').forEach(function(el) {
            el.classList.remove('active');
            el.classList.add('completed');
        });

        if (data.status === 'ok') {
            addLog('Run complete! Redirecting to report...');
            setTimeout(function() {
                window.location.href = '/run/' + runId + '/report';
            }, 2000);
        } else {
            addLog('Run ended: ' + (data.message || data.status));
        }
    });

    // -- Pipeline error --
    source.addEventListener('error', function(e) {
        let msg = 'Connection error';
        try {
            const data = JSON.parse(e.data);
            msg = data.message || msg;
            statusBadge.textContent = 'error';
            statusBadge.className = 'badge badge-error';
            hideAllPanels();
            document.getElementById('stop-container').style.display = 'none';
            addLog('ERROR: ' + msg);
            source.close();
        } catch(_) {
            console.log('SSE connection error, will retry...');
        }
    });

    // -- Stream end --
    source.addEventListener('stream_end', function(e) {
        source.close();
    });
})();
</script>
{% endblock %}
