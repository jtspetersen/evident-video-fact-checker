{% extends "base.html" %}

{% block title %}Evident — {{ runner.video_title or run_id }}{% endblock %}

{% block content %}
<hgroup>
    <h1>Fact-Checking Video: {{ runner.video_title or 'Loading...' }}</h1>
    <p>
        Channel: <strong>{{ runner.channel }}</strong>
        &mdash;
        Status: <span class="badge badge-review">review</span>
    </p>
</hgroup>

<!-- Stage timeline -->
{% set stage_labels = {
    "prepare_transcript": "Prepare Transcript",
    "extract_claims": "Extract Claims",
    "review_claims": "Review Claims",
    "gather_evidence": "Gather Evidence",
    "check_claims": "Check Claims",
    "fact_check_summary": "Fact-Check Summary",
} %}
{% set timings = runner.manifest.get('timings', {}) %}
<div class="stage-timeline" id="stage-timeline">
    {% for stage in runner.STAGE_ORDER %}
    {% set t = timings.get(stage, {}) %}
    <div class="stage-box{% if t.get('finished_utc') %} completed{% elif runner.current_stage == stage %} active{% elif t.get('skipped') %} skipped{% endif %}"
         id="stage-{{ stage }}" data-stage="{{ stage }}">
        {{ stage_labels.get(stage, stage.replace('_', ' ').title()) }}
    </div>
    {% endfor %}
</div>

<h2 style="font-size:1.15em;">Review Extracted Claims</h2>
<p>{{ claims|length }} claims extracted. Select claims you would like to verify.</p>

<form id="review-form">
    <table>
        <thead>
            <tr>
                <th style="width:3rem;">Keep</th>
                <th style="width:5rem;">ID</th>
                <th style="width:8rem;">Type</th>
                <th>Claim</th>
                {# <th style="width:5rem;">Edit</th> — DEPRECATED: edit feature disabled #}
            </tr>
        </thead>
        <tbody>
            {% for c in claims %}
            <tr id="row-{{ c.claim_id }}" data-claim-id="{{ c.claim_id }}">
                <td>
                    <input type="checkbox" class="keep-check"
                           data-claim-id="{{ c.claim_id }}" checked>
                </td>
                <td><code>{{ c.claim_id }}</code></td>
                <td>
                    <span class="badge" style="background:#546e7a;color:#fff;font-size:0.75em;">
                        {{ c.claim_type }}
                    </span>
                </td>
                <td>
                    <div class="claim-text" id="text-{{ c.claim_id }}">{{ c.claim_text }}</div>
                    {% if c.quote_from_transcript %}
                    <details style="margin-top:0.3rem;">
                        <summary><small>Transcript quote</small></summary>
                        <small style="color:var(--pico-muted-color);">{{ c.quote_from_transcript[:300] }}{% if c.quote_from_transcript|length > 300 %}...{% endif %}</small>
                    </details>
                    {% endif %}
                </td>
                {# DEPRECATED: edit feature — uncomment to re-enable
                <td>
                    <div class="edit-panel" id="edit-{{ c.claim_id }}" style="display:none; margin-top:0.5rem;">
                        <label>
                            <small>Claim text:</small>
                            <textarea class="edit-claim-text" rows="2" style="font-size:0.9em;">{{ c.claim_text }}</textarea>
                        </label>
                        <label>
                            <small>Quote:</small>
                            <textarea class="edit-quote" rows="2" style="font-size:0.9em;">{{ c.quote_from_transcript or '' }}</textarea>
                        </label>
                        <label>
                            <small>Type:</small>
                            <select class="edit-type">
                                {% for t in ['statistic', 'event_date', 'quote_attribution', 'causal', 'medical_science', 'policy_legal', 'study_says', 'biography', 'other'] %}
                                <option value="{{ t }}" {{ 'selected' if c.claim_type == t else '' }}>{{ t }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>
                    <button type="button" class="outline secondary edit-btn"
                            data-claim-id="{{ c.claim_id }}"
                            style="padding:0.3em 0.6em; font-size:0.8em;">
                        Edit
                    </button>
                </td>
                #}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="display:flex; gap:1rem; margin-top:1rem;">
        <button type="button" id="submit-review" class="primary">
            Submit Review &amp; Continue
        </button>
        <button type="button" id="keep-all" class="outline">Keep All</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const runId = '{{ run_id }}';

    // Keep all
    document.getElementById('keep-all').addEventListener('click', function() {
        document.querySelectorAll('.keep-check').forEach(cb => { cb.checked = true; });
    });

    // Submit review
    document.getElementById('submit-review').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.setAttribute('aria-busy', 'true');

        const decisions = [];
        document.querySelectorAll('tr[data-claim-id]').forEach(row => {
            const claimId = row.dataset.claimId;
            const kept = row.querySelector('.keep-check').checked;
            decisions.push({
                claim_id: claimId,
                action: kept ? 'keep' : 'drop',
            });
        });

        fetch('/run/' + runId + '/review', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(decisions),
        }).then(function() {
            window.location.href = '/run/' + runId;
        }).catch(function(err) {
            alert('Error submitting review: ' + err);
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
        });
    });

    /* DEPRECATED: edit feature JS — uncomment to re-enable
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const cid = this.dataset.claimId;
            const panel = document.getElementById('edit-' + cid);
            const showing = panel.style.display !== 'none';
            panel.style.display = showing ? 'none' : 'block';
            this.textContent = showing ? 'Edit' : 'Close';
        });
    });
    */
})();
</script>
{% endblock %}
