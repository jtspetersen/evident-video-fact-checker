{% extends "base.html" %}

{% block title %}Evident â€” Video Fact-checker{% endblock %}

{% block content %}
<hgroup>
    <h1>Video Fact-checker</h1>
    <p>Provide a YouTube URL or upload a transcript to begin fact-checking.</p>
</hgroup>

<!-- Input mode toggle -->
<div role="group" style="margin-bottom:1rem;">
    <button type="button" id="mode-url-btn" onclick="setMode('url')">YouTube URL</button>
    <button type="button" id="mode-file-btn" class="secondary" onclick="setMode('file')">Upload File</button>
</div>

<form action="/url" method="post" enctype="application/x-www-form-urlencoded" id="main-form" novalidate>
    <!-- YouTube URL input section (visible by default) -->
    <div id="url-input-section">
        <label for="youtube-url">
            YouTube Video URL
            <input type="url" name="youtube_url" id="youtube-url"
                   placeholder="https://www.youtube.com/watch?v=..." required>
        </label>
        <small>Supports youtube.com/watch, youtu.be, shorts, and embed URLs</small>
    </div>

    <!-- File input section (hidden by default) -->
    <div id="file-input-section" style="display:none;">
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
            <p><strong>Drag &amp; drop a transcript file here</strong></p>
            <p><small>or click to browse (.txt, .md)</small></p>
            <input type="file" name="transcript" id="file-input" accept=".txt,.md">
            <p id="file-name" style="display:none; margin-top:0.5rem;"></p>
        </div>

        <label for="video-title" style="margin-top:1rem;">
            Video Title
            <input type="text" name="video_title" id="video-title">
        </label>

        <label for="channel">
            Channel / Creator Name
            <input type="text" name="channel" id="channel">
        </label>
    </div>

    <!-- Options -->
    <fieldset>
        <legend>Options</legend>
        <label>
            <input type="checkbox" name="review" value="true">
            Enable claim review (pause pipeline to review/edit extracted claims)
        </label>
    </fieldset>

    <!-- Submit -->
    <button type="submit" id="submit-btn">Fetch & Fact-Check</button>
</form>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const form = document.getElementById('main-form');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileName = document.getElementById('file-name');
    const submitBtn = document.getElementById('submit-btn');
    const fileSection = document.getElementById('file-input-section');
    const urlSection = document.getElementById('url-input-section');
    const urlInput = document.getElementById('youtube-url');
    const fileModeBtn = document.getElementById('mode-file-btn');
    const urlModeBtn = document.getElementById('mode-url-btn');
    const videoTitleInput = document.getElementById('video-title');
    const channelInput = document.getElementById('channel');

    let currentMode = 'url';

    // Mode toggle
    window.setMode = function(mode) {
        currentMode = mode;
        if (mode === 'url') {
            fileSection.style.display = 'none';
            urlSection.style.display = 'block';
            form.action = '/url';
            form.enctype = 'application/x-www-form-urlencoded';
            fileInput.removeAttribute('required');
            fileInput.value = '';
            urlInput.setAttribute('required', '');
            fileModeBtn.className = 'secondary';
            urlModeBtn.className = '';
            submitBtn.textContent = 'Fetch & Fact-Check';
        } else {
            fileSection.style.display = 'block';
            urlSection.style.display = 'none';
            form.action = '/upload';
            form.enctype = 'multipart/form-data';
            urlInput.removeAttribute('required');
            urlInput.value = '';
            fileInput.setAttribute('required', '');
            urlModeBtn.className = 'secondary';
            fileModeBtn.className = '';
            submitBtn.textContent = 'Start Fact-Check';
        }
    };

    // Custom validation on submit
    form.addEventListener('submit', function(e) {
        if (currentMode === 'url') {
            if (!urlInput.value.trim()) {
                e.preventDefault();
                urlInput.setCustomValidity('Please enter a YouTube URL.');
                urlInput.reportValidity();
                return;
            }
            urlInput.setCustomValidity('');
        } else {
            if (!fileInput.files.length) {
                e.preventDefault();
                fileInput.setCustomValidity('Please select a transcript file.');
                fileInput.reportValidity();
                return;
            }
            fileInput.setCustomValidity('');
            if (!videoTitleInput.value.trim()) {
                e.preventDefault();
                videoTitleInput.setCustomValidity('Please enter the video title.');
                videoTitleInput.reportValidity();
                return;
            }
            videoTitleInput.setCustomValidity('');
            if (!channelInput.value.trim()) {
                e.preventDefault();
                channelInput.setCustomValidity('Please enter the channel or creator name.');
                channelInput.reportValidity();
                return;
            }
            channelInput.setCustomValidity('');
        }

        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');
        submitBtn.textContent = currentMode === 'url' ? 'Fetching...' : 'Starting...';
    });

    // Clear custom validity on input
    urlInput.addEventListener('input', function() { this.setCustomValidity(''); });
    videoTitleInput.addEventListener('input', function() { this.setCustomValidity(''); });
    channelInput.addEventListener('input', function() { this.setCustomValidity(''); });

    // Drag & drop
    ['dragenter', 'dragover'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
    });
    ['dragleave', 'drop'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
    });
    dropZone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            showFileName(files[0].name);
        }
    });

    // File picker
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            showFileName(fileInput.files[0].name);
            fileInput.setCustomValidity('');
        }
    });

    function showFileName(name) {
        fileName.textContent = 'Selected: ' + name;
        fileName.style.display = 'block';
    }
})();
</script>
{% endblock %}
